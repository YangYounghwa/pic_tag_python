<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - 클라이언트 웹캠</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%;
        }
        h1, h2 {
            color: #333;
        }
        video {
            width: 100%;
            max-width: 640px; /* 비디오 최대 너비 설정 */
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #000; /* 로딩 중 배경 */
        }
        .controls {
            margin-top: 20px;
        }
        .controls button {
            padding: 12px 25px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .controls button.start {
            background-color: #28a745;
            color: white;
        }
        .controls button.start:hover {
            background-color: #218838;
        }
        .controls button.stop {
            background-color: #dc3545;
            color: white;
        }
        .controls button.stop:hover {
            background-color: #c82333;
        }
        .controls button.back {
            background-color: #007bff;
            color: white;
        }
        .controls button.back:hover {
            background-color: #0056b3;
        }
        #statusMessage {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ request.user.username }}님, 대시보드입니다!</h1>
        <p>클라이언트 웹캠 스트림을 보여줍니다.</p>

        <h2>클라이언트 웹캠 피드</h2>
        <video id="clientWebcamVideo" autoplay playsinline></video>
        <p id="statusMessage"></p>

        <div class="controls">
            <button class="start" id="startWebcam">웹캠 시작</button>
            <button class="stop" id="stopWebcam" disabled>웹캠 중지</button>
            <a href="{% url 'home' %}">
                <button class="back">홈으로 돌아가기</button>
            </a>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('clientWebcamVideo');
        const startButton = document.getElementById('startWebcam');
        const stopButton = document.getElementById('stopWebcam');
        const statusMessage = document.getElementById('statusMessage');
        let currentStream; // 웹캠 스트림을 저장할 변수

        // 웹캠 시작 함수
        async function startWebcam() {
            statusMessage.textContent = '웹캠 스트림을 시작하는 중...';
            try {
                // 사용자에게 카메라 접근 권한 요청
                // { audio: true, video: true } 로 하면 오디오와 비디오 모두 요청
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                videoElement.srcObject = currentStream; // 비디오 요소에 스트림 연결
                videoElement.play(); // 비디오 재생
                startButton.disabled = true; // 시작 버튼 비활성화
                stopButton.disabled = false;  // 중지 버튼 활성화
                statusMessage.textContent = '웹캠 스트림 중입니다.';
                console.log('웹캠 스트림 시작됨.');
            } catch (err) {
                statusMessage.textContent = `웹캠 접근 오류: ${err.name} - ${err.message}`;
                console.error('웹캠 접근에 실패했습니다: ', err);
                startButton.disabled = false; // 시작 버튼 다시 활성화
                stopButton.disabled = true;  // 중지 버튼 비활성화
            }
        }

        // 웹캠 중지 함수
        function stopWebcam() {
            if (currentStream) {
                // 스트림의 모든 트랙(비디오, 오디오 등)을 중지
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    console.log(`트랙 중지됨: ${track.kind}`);
                });
                videoElement.srcObject = null; // 비디오 요소에서 스트림 연결 해제
                currentStream = null; // 스트림 변수 초기화
                startButton.disabled = false; // 시작 버튼 활성화
                stopButton.disabled = true;  // 중지 버튼 비활성화
                statusMessage.textContent = '웹캠 스트림이 중지되었습니다.';
                console.log('웹캠 스트림 중지됨.');
            }
        }

        // 버튼에 이벤트 리스너 추가
        startButton.addEventListener('click', startWebcam);
        stopButton.addEventListener('click', stopWebcam);

        // 페이지를 떠날 때 웹캠 스트림 자동 중지
        window.addEventListener('beforeunload', () => {
            stopWebcam();
        });
    </script>
</body>
</html>